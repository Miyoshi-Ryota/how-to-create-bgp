<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.15">
<meta name="author" content="Miyoshi Ryota (@llp_qlv / mr-csce (miyoshi))">
<title>作って学ぶルーティングプロトコル〜RustでBGPを実装〜</title>
<style>

</style>
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #408080; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #7D9029 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #A0A000 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>作って学ぶルーティングプロトコル〜RustでBGPを実装〜</h1>
<div class="details">
<span id="author" class="author">Miyoshi Ryota (@llp_qlv / mr-csce (miyoshi))</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_はじめに">はじめに</a>
<ul class="sectlevel2">
<li><a href="#_執筆環境">執筆環境</a></li>
</ul>
</li>
<li><a href="#_bgpの実装に必要な知識の学習">BGPの実装に必要な知識の学習</a>
<ul class="sectlevel2">
<li><a href="#_bgpとは">BGPとは</a></li>
<li><a href="#_bgpはイベント駆動ステートマシン">BGPはイベント駆動ステートマシン</a></li>
<li><a href="#what_is_event_driven_state_machine">イベント駆動ステートマシンとは</a></li>
<li><a href="#_イベント駆動ステートマシンの例">イベント駆動ステートマシンの例</a></li>
</ul>
</li>
<li><a href="#_1つのピアを実装するまで">1つのピアを実装するまで</a>
<ul class="sectlevel2">
<li><a href="#_bgpはどんなイベント駆動ステートマシンなのか">BGPはどんなイベント駆動ステートマシンなのか</a></li>
<li><a href="#first_rev">1つのピアがEstablishedに遷移するところまでの実装</a></li>
<li><a href="#_1つのピアでupdate_messageの交換やupdate_messageの内容に従ってrouting_tableへの書き込みを可能にするところまでの実装">1つのピアでUpdate Messageの交換やUpdate Messageの内容に従ってRouting Tableへの書き込みを可能にするところまでの実装</a></li>
<li><a href="#_main関数の実装">main関数の実装</a></li>
<li><a href="#_本章で作るものの全体像">本章で作るものの全体像</a></li>
</ul>
</li>
<li><a href="#_複数ピアをハンドリング可能な実装">複数ピアをハンドリング可能な実装</a>
<ul class="sectlevel2">
<li><a href="#_本章で作るものの全体像_2">本章で作るものの全体像</a></li>
</ul>
</li>
<li><a href="#_他社実装との疎通確認">他社実装との疎通確認</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_はじめに">はじめに</h2>
<div class="sectionbody">
<div class="paragraph">
<p>現在執筆中です。
なお本書の一部はChrome / Firefoxでしか動作しません。
Safari / IE / Edgeでは動作しません。</p>
</div>
<div class="paragraph">
<p>次の本書のGitHubリポジトリや、本書で作成したBGPデーモンのリポジトリにStarをいただけると嬉しいです。</p>
</div>
本書のリポジトリ：
<iframe src="https://ghbtns.com/github-btn.html?user=Miyoshi-Ryota&repo=how-to-create-bgp
&type=star&count=true&size=large" frameborder="0" scrolling="0" width="170" height="30" title="GitHub"></iframe>
本書で作成したBGPデーモンのリポジトリ：
<iframe src="https://ghbtns.com/github-btn.html?user=Miyoshi-Ryota&repo=mrbgpdv2
&type=star&count=true&size=large" frameborder="0" scrolling="0" width="170" height="30" title="GitHub"></iframe>
<div class="paragraph">
<p>本書ではルーティングプロトコルの1つであるBGP（特に今回はEBGP4）をRustで実装する本です。
読者に以下の前提知識を求めています。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ルーティングプロトコルは聞いたことがある。</p>
</li>
<li>
<p>スタティックルートとは何か分かる。</p>
</li>
<li>
<p>ルーティングテーブルを見て意味が分かる。</p>
</li>
<li>
<p>何らかのプログラミング言語でのプログラミング経験</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>以下の経験があるとよりわかりやすいかもしれません。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>BGPの運用経験</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_執筆環境">執筆環境</h3>
<div class="paragraph">
<p>筆者は以下の環境で作成・動作確認しています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ubuntu 20.04 LTS / Pop!_OS 20.04 LTS</p>
</li>
<li>
<p>cargo 1.53.0-nightly (f3e13226d 2021-04-30)</p>
</li>
<li>
<p>rustc 1.54.0-nightly (676ee1472 2021-05-06)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>おそらくほとんど全てのLinux Distribution、MacOSでも動作するものと考えていますが、確認・テストはしていません。
RustのVersionについても同様にテストしていませんが、
ある程度新しければ動作すると考えています。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bgpの実装に必要な知識の学習">BGPの実装に必要な知識の学習</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_bgpとは">BGPとは</h3>
<div class="paragraph">
<p>本章は執筆予定です。すでに良い教材が多く存在するため後回しにしています。
本章が執筆されるまでの参考文献として、2つ紹介します。
BGPについて詳しくない方は、どちらかを読み、本章以降に進んでください。
すべての内容を記憶する必要はありません。
なんとなく見ておくと、本章以降の理解が容易になります。</p>
</div>
<div class="paragraph">
<p><a href="https://www.infraexpert.com/study/study60.html">ネットワークエンジニアとして - BGPの技術</a>の次の章が参考になります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.infraexpert.com/study/bgpz01.html">BGP（ Border Gateway Protocol ）とは</a></p>
</li>
<li>
<p><a href="https://www.infraexpert.com/study/bgpz02.html">BGP - 4つのメッセージ、6つのステータスと状態遷移</a></p>
</li>
<li>
<p><a href="https://www.infraexpert.com/study/bgpz03.html">BGP - IBGPとEBGPの違い</a></p>
</li>
<li>
<p><a href="https://www.infraexpert.com/study/bgpz04.html">BGP - スタブAS、トランジットAS、非トランジットAS</a></p>
</li>
<li>
<p><a href="https://www.infraexpert.com/study/bgpz05.html">BGP - パスアトリビュート（ パス属性 ）＆ ベストパス選択</a></p>
</li>
<li>
<p><a href="https://www.infraexpert.com/study/bgpz06.html">BGP - コンフィグ設定 - 基本設定</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="http://www5e.biglobe.ne.jp/aji/30min/index.html">30分間ネットワーキング</a>の次の章が参考になります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://www5e.biglobe.ne.jp/aji/30min/16.html">第16回 BGP4(1) AS</a></p>
</li>
<li>
<p><a href="http://www5e.biglobe.ne.jp/aji/30min/17.html">第17回 BGP4(2) BGPピア</a></p>
</li>
<li>
<p><a href="http://www5e.biglobe.ne.jp/aji/30min/18.html">第18回 BGP4(3) IBGPとEBGP</a></p>
</li>
<li>
<p><a href="http://www5e.biglobe.ne.jp/aji/30min/19.html">第19回 BGP4(4) パスアトリビュート</a></p>
</li>
<li>
<p><a href="http://www5e.biglobe.ne.jp/aji/30min/20.html">第20回 BGP4(5) ベストパス選択</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_bgpはイベント駆動ステートマシン">BGPはイベント駆動ステートマシン</h3>

</div>
<div class="sect2">
<h3 id="what_is_event_driven_state_machine">イベント駆動ステートマシンとは</h3>
<div class="paragraph">
<p>イベント駆動ステートマシンとは、現在の状態（ステート）と入力（イベント）によって動作が決定するモノのモデルです。</p>
</div>
<div class="paragraph">
<p>例として、テレビをステートマシンとして表現します。
テレビの状態として、1. 電源ON、2. 電源OFFの2状態が存在し、入力としてa. 電源ボタンの押下、b. 音量増加ボタンの押下、c. 音量減少ボタンの押下の3つが存在するとします。本来のテレビはもっと多数の状態やイベントを持っていますが、ここでは例示のためにシンプルにしています。</p>
</div>
<div class="paragraph">
<p>テレビの状態が1. 電源OFFのときにa. 電源ボタンの押下が発生した場合はテレビの状態が2. 電源ONに遷移します。テレビの状態が1. 電源OFFのときに、b. 音量増加ボタンの押下、c. 音量減少ボタンの押下が発生した場合はテレビの状態は1. 電源OFFのままで何も起こりません。</p>
</div>
<div class="paragraph">
<p>テレビの状態が2. 電源ONのときにa. 電源ボタンの押下が発生した場合はテレビの状態が2. 電源OFFに遷移します。テレビの状態が2. 電源ONのときb. 音量増加ボタンの押下、c. 音量減少ボタンの押下が発生した場合は、テレビの状態は2. 電源ONのまま音量が増減します。</p>
</div>
<div class="paragraph">
<p>このように現在の状態と、入力によって動作が決定するモノとして表現することが可能です。これを図示すると<a href="#example_state_machine_diagram">テレビのステートマシン図</a>になります。</p>
</div>
<div id="example_state_machine_diagram" class="imageblock">
<div class="content">
<img src="diag-95fa917fdc8d0fc994b7257135719e26.png" alt="Diagram" width="456" height="197">
</div>
<div class="title">Figure 1. テレビのステートマシン図</div>
</div>
<div class="paragraph">
<p>本書ではステートマシン図では表しにくい動作の内容について、<a href="#example_state_machine_diagram_2">テレビのイベント駆動ステートマシンとしての表現（本書の記法）</a>のように付箋をつけることにします。
この図では、状態が電源ONのときに、音量増加ボタンの押下が入力されたときには、状態を電源ONのままにするだけでなく、音量を増加させることを表しています。</p>
</div>
<div id="example_state_machine_diagram_2" class="imageblock">
<div class="content">
<img src="diag-e41e51f37737f9dea8a32125e9e7f18d.png" alt="Diagram" width="456" height="205">
</div>
<div class="title">Figure 2. テレビのイベント駆動ステートマシンとしての表現（本書の記法）</div>
</div>
</div>
<div class="sect2">
<h3 id="_イベント駆動ステートマシンの例">イベント駆動ステートマシンの例</h3>
<div class="paragraph">
<p>イベント駆動ステートマシンをどのよう実装すればいいのかという勘所を掴んでもらうために<a href="#what_is_event_driven_state_machine">イベント駆動ステートマシンとは</a>の章で例示したテレビをコードにします。
次のようになります。</p>
</div>
<div id="example_of_state_machine_impl" class="listingblock">
<div class="title">イベント駆動ステートマシンの例（テレビ）</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">rand</span>::<span class="tok-n">Rng</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">collections</span>::<span class="tok-n">VecDeque</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">thread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">time</span>::<span class="tok-n">Duration</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-cp">#[derive(Debug)]</span><span class="tok-w"></span>
<span class="tok-k">enum</span> <span class="tok-nc">State</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">PowerOn</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">PowerOff</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cp">#[derive(Debug)]</span><span class="tok-w"></span>
<span class="tok-k">enum</span> <span class="tok-nc">Event</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">PushedPowerButton</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">PushedVolumeIncreaseButton</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">PushedVolumeDecreaseButton</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">TV</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">now_state</span>: <span class="tok-nc">State</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">event_queue</span>: <span class="tok-nc">EventQueue</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">volume</span>: <span class="tok-kt">u8</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">TV</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">new</span><span class="tok-p">()</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">Self</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">now_state</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">PowerOff</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">event_queue</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">EventQueue</span>::<span class="tok-n">new</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">volume</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-mi">10</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">Self</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">now_state</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">event_queue</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">volume</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">be_pushed_power_button</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">event_queue</span><span class="tok-p">.</span><span class="tok-n">enqueue</span><span class="tok-p">(</span><span class="tok-n">Event</span>::<span class="tok-n">PushedPowerButton</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">be_pushed_volume_increase_button</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">event_queue</span><span class="tok-p">.</span><span class="tok-n">enqueue</span><span class="tok-p">(</span><span class="tok-n">Event</span>::<span class="tok-n">PushedVolumeIncreaseButton</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">be_pushed_volume_decrease_button</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">event_queue</span><span class="tok-p">.</span><span class="tok-n">enqueue</span><span class="tok-p">(</span><span class="tok-n">Event</span>::<span class="tok-n">PushedVolumeDecreaseButton</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">handle_event</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">event</span>: <span class="tok-nc">Event</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-o">&amp;</span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-o">&amp;</span><span class="tok-n">State</span>::<span class="tok-n">PowerOn</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">Event</span>::<span class="tok-n">PushedPowerButton</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">PowerOff</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">Event</span>::<span class="tok-n">PushedVolumeIncreaseButton</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">volume</span><span class="tok-w"> </span><span class="tok-o">+=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">Event</span>::<span class="tok-n">PushedVolumeDecreaseButton</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">volume</span><span class="tok-w"> </span><span class="tok-o">-=</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-p">},</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-o">&amp;</span><span class="tok-n">State</span>::<span class="tok-n">PowerOff</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">Event</span>::<span class="tok-n">PushedPowerButton</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">PowerOn</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-p">},</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">EventQueue</span><span class="tok-p">(</span><span class="tok-n">VecDeque</span><span class="tok-o">&lt;</span><span class="tok-n">Event</span><span class="tok-o">&gt;</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">EventQueue</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">new</span><span class="tok-p">()</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">Self</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">d</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">VecDeque</span>::<span class="tok-n">new</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">EventQueue</span><span class="tok-p">(</span><span class="tok-n">d</span><span class="tok-p">)</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">dequeue</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Option</span><span class="tok-o">&lt;</span><span class="tok-n">Event</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-mf">0.</span><span class="tok-n">pop_front</span><span class="tok-p">()</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">enqueue</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">event</span>: <span class="tok-nc">Event</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-mf">0.</span><span class="tok-n">push_back</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-k">fn</span> <span class="tok-nf">push_random_button_of_tv</span><span class="tok-p">(</span><span class="tok-n">tv</span>: <span class="tok-kp">&amp;</span><span class="tok-nc">mut</span><span class="tok-w"> </span><span class="tok-n">TV</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">rng</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">rand</span>::<span class="tok-n">thread_rng</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">rng</span><span class="tok-p">.</span><span class="tok-n">gen_range</span><span class="tok-p">(</span><span class="tok-mi">0</span><span class="tok-o">..</span><span class="tok-mi">4</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-mi">1</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">be_pushed_power_button</span><span class="tok-p">(),</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-mi">2</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">be_pushed_volume_increase_button</span><span class="tok-p">(),</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-mi">3</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">be_pushed_volume_decrease_button</span><span class="tok-p">(),</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">};</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-k">fn</span> <span class="tok-nf">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">tv</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">TV</span>::<span class="tok-n">new</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">be_pushed_power_button</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">loop</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">push_random_button_of_tv</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">tv</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">event_queue</span><span class="tok-p">.</span><span class="tok-n">dequeue</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-fm">println!</span><span class="tok-p">(</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-s">&quot;tv information: {{ now_state={:?}, volume={} }}</span><span class="tok-se">\n</span><span class="tok-s">input_event: {:?}&quot;</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">volume</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">tv</span><span class="tok-p">.</span><span class="tok-n">handle_event</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">thread</span>::<span class="tok-n">sleep</span><span class="tok-p">(</span><span class="tok-n">Duration</span>::<span class="tok-n">from_secs</span><span class="tok-p">(</span><span class="tok-mi">2</span><span class="tok-p">));</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>103行目でTVのランダムなボタンを押下し、TVにイベント（入力）を送信しています。送信されたEventはイベントキュー、tv.event_queueにエンキューします。
104でイベントキューに保存されているイベント（入力）を取り出します。
TVの現在の状態（State）はTVのインスタンスに保存されています。
109行目でイベント（入力）を扱います。
49行目〜69行目を見ると分かるように、`tv.handle_event(event)`はeventとtvインスタンスに保存されている現在の状態に応じて、動作し次の状態を決定します。
それはイベント駆動ステートマシン、そのものでした。このようにしてイベント駆動ステートマシンを実装することができました。</p>
</div>
<div class="paragraph">
<p>次が<a href="#log_of_sample_state_machine">実行時のログ</a>です。</p>
</div>
<div class="paragraph">
<p>ログの4行目を見ると、電源OFFの状態であることがわかります。
次にログの5行目を見ると、電源ボタンが押されたことがわかります。
次にログの6行目を見ると、電源ONの状態に遷移したことがわかります。
次にログの7行目を見ると、音量増加ボタンが押されたことがわかります。
次にログの8行目を見ると、電源ON状態のまま、音量が11に増加していることがわかります。</p>
</div>
<div class="paragraph">
<p>一方でログの16、17、18行目を見ると、電源OFF状態のときに音量増加ボタンが押されても、電源OFF状態のままで音量の変動もないことがわかります。</p>
</div>
<div id="log_of_sample_state_machine" class="listingblock">
<div class="title">実行時のログ</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="html"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><pre><span></span>mrcsce@pop-os:~/programming/rustProjects/samplecode$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.00s
     Running `target/debug/samplecode`
tv information: { now_state=PowerOff, volume=10 }
input_event: PushedPowerButton
tv information: { now_state=PowerOn, volume=10 }
input_event: PushedVolumeIncreaseButton
tv information: { now_state=PowerOn, volume=11 }
input_event: PushedVolumeDecreaseButton
tv information: { now_state=PowerOn, volume=10 }
input_event: PushedVolumeIncreaseButton
tv information: { now_state=PowerOn, volume=11 }
input_event: PushedVolumeDecreaseButton
tv information: { now_state=PowerOn, volume=10 }
input_event: PushedPowerButton
tv information: { now_state=PowerOff, volume=10 }
input_event: PushedVolumeIncreaseButton
tv information: { now_state=PowerOff, volume=10 }
input_event: PushedPowerButton
tv information: { now_state=PowerOn, volume=10 }
input_event: PushedVolumeIncreaseButton
tv information: { now_state=PowerOn, volume=11 }
input_event: PushedVolumeIncreaseButton
^C
mrcsce@pop-os:~/programming/rustProjects/samplecode$
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>これは<a href="#what_is_event_driven_state_machine">イベント駆動ステートマシンとは</a>の章で例示した通りの動作です。
例示したイベント駆動ステートマシンを実装できていることが確かめられました。
BGPのステートマシンも前述の<a href="#example_of_state_machine_impl">イベント駆動ステートマシンの例（テレビ）</a>に似た方針で実装していきます。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1つのピアを実装するまで">1つのピアを実装するまで</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_bgpはどんなイベント駆動ステートマシンなのか">BGPはどんなイベント駆動ステートマシンなのか</h3>
<div class="paragraph">
<p>BGPはどのようなイベント駆動ステートマシンとして表すのが良いでしょうか。</p>
</div>
<div class="paragraph">
<p>実は <a href="https://tools.ietf.org/html/rfc4271">RFC4271-A Border Gateway Protocol 4 (BGP-4)</a>の <a href="https://tools.ietf.org/html/rfc4271#section-8">8.  BGP Finite State Machine (FSM)</a>に、イベント駆動ステートマシンの定義の記載があります。</p>
</div>
<div class="paragraph">
<p>しかし最初から <a href="https://tools.ietf.org/html/rfc4271#section-8">8.  BGP Finite State Machine (FSM)</a>を参照して、完全なBGPを作成することは大変です。
そのため本書ではBGPを次の段階に分けて開発します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>まずは1つのピアがEstablishedに遷移可能</p>
</li>
<li>
<p>1つのピアでUpdate Messageの交換やUpdate Messageの内容にしたがってRouting Tableへの書き込みが可能</p>
</li>
<li>
<p>複数のピアを扱うことが可能</p>
</li>
<li>
<p>細かい完成度を増加</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>本章のコードは GitHubの <a href="https://github.com/Miyoshi-Ryota/mrbgpdv2">本書のリポジトリ</a>にすべて公開しています。
本書中にすべてのコードを乗せるつもりですが、断片のコードではなくすべてのコードを一気に閲覧したい方はリポジトリを参照してください。
また本章の第一段階「<a href="#first_rev">1つのピアがEstablishedに遷移するところまでの実装</a>」のコードは同リポジトリの <a href="https://github.com/Miyoshi-Ryota/mrbgpdv2/tree/main/mrbgpdv2first">同リポジトリのmrbgpdv2first/</a> に存在します。</p>
</div>
</div>
<div class="sect2">
<h3 id="first_rev">1つのピアがEstablishedに遷移するところまでの実装</h3>
<div class="paragraph">
<p>まずは1つのピアがEstablishedに至るまでの正常系のみのイベント駆動ステートマシンを実装します。</p>
</div>
<div class="paragraph">
<p>RFCの方針の通り、1つのBGPピアを1つのイベント駆動ステートマシンとして表します。
BGPのイベント駆動ステートマシンの状態もIdle, Connect, OpenConfirm, OpenSent, Establishedの5つ用意します。
この状態は、 <a href="https://www.infraexpert.com/study/bgpz02.html">BGP - 4つのメッセージ、6つのステータスと状態遷移</a> で説明しているBGPの6つの状態のうちActiveを除いたものと対応しています。Activeは非正常系パスでしか遷移しない状態のため、第一段階では除いています。</p>
</div>
<div class="paragraph">
<p>第一段階のイベントとして次の5個を使用します。イベントの名前と定義はRFCにしたがってしています。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. BGPのイベント駆動ステートマシンのイベント</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">イベント名</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">定義</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ManualStart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">システムの管理者が手動でピアのコネクションをスタートさせた際のイベント</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tcp_CR_Acked</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCPコネクションのリクエストを確立させた際のイベント。言い換えれば、システムがTCP SYNを送信し、TCP SYN/ACKを受信し、TCP ACKを送信したときのイベント。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TcpConnectionConfirmed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCPコネクションが確立された際のイベント。言い換えれば、対向先からTCP SYNを受け取り、システムがTCP SYN/ACKを送信し、TCP ACKを受信したときのイベント</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BGPOpen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">正常なOpen Messageを受信したときのイベント</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KeepAliveMsg</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keepalive Messageを受信したときのイベント</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以下に<a href="#first_impl_bgp">第一段階で実装するステートマシン</a>を図示します。図中の黒丸はステートマシンの初期状態を表しています。図示していない（想定していない）遷移が発生した場合はすべてクラッシュすることにします。例えば、Connect状態で、BGP Open eventが発生した場合はクラッシュすることにします。</p>
</div>
<div id="first_impl_bgp" class="imageblock">
<div class="content">
<img src="diag-e983b047b02e8c158eea3507a8d49459.png" alt="Diagram" width="390" height="775">
</div>
<div class="title">Figure 3. 第一段階で実装するステートマシン</div>
</div>
<div class="sect3">
<h4 id="_作業の明確化">作業の明確化</h4>
<div class="paragraph">
<p>ここまででなんとなく作るものが見えてきたでしょうか。本章では、<a href="#first_rev">1つのピアがEstablishedに遷移するところまでの実装</a>をToDoレベルに明確化します。</p>
</div>
<div class="ulist checklist">
<div class="title">タスクリスト</div>
<ul class="checklist">
<li>
<p>&#10063; プロジェクトを作成する</p>
</li>
<li>
<p>&#10063; Connect Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; ManualStart Eventを発生させる</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; OpenSent Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; TCPコネクションを作成する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; OpenConfirm Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Open Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Open Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Established Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Keepalive Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Keepalive Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; main関数を作成する</p>
</li>
<li>
<p>&#10063; テストする</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_プロジェクトの作成">プロジェクトの作成</h4>
<div class="paragraph">
<p>Rustは以下のコマンドで新しいプロジェクトを作成することが出来ます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code><span></span>cargo new &lt;プロジェクトの名前&gt;</code></pre>
</div>
</div>
<div class="ulist checklist">
<div class="title">タスクリスト</div>
<ul class="checklist">
<li>
<p>&#10003; プロジェクトを作成する</p>
</li>
<li>
<p>&#10063; Connect Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; ManualStart Eventを発生させる</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; OpenSent Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; TCPコネクションを作成する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; OpenConfirm Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Open Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Open Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Established Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Keepalive Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Keepalive Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; main関数を作成する</p>
</li>
<li>
<p>&#10063; テストする</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_connect_stateに遷移する">Connect Stateに遷移する</h4>
<div class="paragraph">
<p>それでは中身に入っていきましょう。
下記に取り組みます。</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; Connect Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; ManualStart Eventを発生させる</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>BGPは1つのピアが1つのイベント駆動ステートマシンとして表せます。
ピアに関するソースコードは./src/bgp/peer.rsに書くことにしましょう。</p>
</div>
<div class="literalblock">
<div class="content">
<pre class="nowrap">./src/bgp/peer.rsを追加するとディレクトリ構造は下記のようになります。</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight nowrap"><code><span></span>mrcsce@pop-os:~/programming/rustProjects/mrbgpdv2/mrbgpdv2first$ tree
.
├── Cargo.lock
├── Cargo.toml
├── src
│   ├── bgp
│   │   ├── mod.rs
│   │   └── peer.rs
│   ├── lib.rs
│   └── main.rs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">"./lib.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">mod</span> <span class="tok-nn">bgp</span><span class="tok-p">;</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">"./bgp/mod.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">mod</span> <span class="tok-nn">peer</span><span class="tok-p">;</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">"./bgp/peer.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><pre><span></span><span class="tok-c1">// 空ファイルです</span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>まずテストを書きましょう。
Connectに遷移するまでの過程は<a href="#bgp_first_test">次</a>のようにしてみましょう。</p>
</div>
<div id="bgp_first_test" class="listingblock">
<div class="title">src/bgp/peer.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#[cfg(test)]</span><span class="tok-w"></span>
<span class="tok-k">mod</span> <span class="tok-nn">tests</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-k">super</span>::<span class="tok-o">*</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-cp">#[test]</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">fn</span> <span class="tok-nf">peer_can_transition_to_connect_start</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">config</span>: <span class="tok-nc">Config</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;64512 127.0.0.1 64513 127.0.0.2 active&quot;</span><span class="tok-p">.</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">bgp_peer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Peer</span>::<span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">config</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">bgp_peer</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">bgp_peer</span><span class="tok-p">.</span><span class="tok-n">next_step</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-fm">assert_eq!</span><span class="tok-p">(</span><span class="tok-n">bgp_peer</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">Connect</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>bgp_peer.start()でピアのコネクションを開始（ManualStartイベントを発火）させ、bgp_peer.next_step()で、そのピアのイベントキューからイベントを1つ取り出しハンドリングするつもりのコードです。</p>
</div>
<div class="paragraph">
<p>実はConnect Stateに遷移するところまででは、Configは不要です。しかしこの後、すぐに使用するので、この段階で合わせて実装しています。</p>
</div>
<div class="paragraph">
<p>このテストが通るまでコンパイラのエラーにしたがってコードを追加していくと下記のようになります。</p>
</div>
<div class="listingblock">
<div class="title">ディレクトリ構造</div>
<div class="content">
<pre class="pygments highlight nowrap"><code><span></span>├── src
│   ├── bgp
│   │   ├── config.rs
│   │   ├── event_queue.rs
│   │   ├── mod.rs
│   │   └── peer.rs
│   ├── lib.rs
│   └── main.rs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/bgp/mod.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">mod</span> <span class="tok-nn">config</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">mod</span> <span class="tok-nn">event_queue</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">mod</span> <span class="tok-nn">peer</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">AutonomousSystemNumber</span><span class="tok-p">(</span><span class="tok-kt">u16</span><span class="tok-p">);</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/bgp/peer.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-k">super</span>::<span class="tok-n">event_queue</span>::<span class="tok-n">EventQueue</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-k">crate</span>::<span class="tok-n">bgp</span>::<span class="tok-n">config</span>::<span class="tok-n">Config</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-k">struct</span> <span class="tok-nc">Peer</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">config</span>: <span class="tok-nc">Config</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">event_queue</span>: <span class="tok-nc">EventQueue</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">now_state</span>: <span class="tok-nc">State</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">Peer</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">new</span><span class="tok-p">(</span><span class="tok-n">config</span>: <span class="tok-nc">Config</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">Self</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">event_queue</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">EventQueue</span>::<span class="tok-n">new</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">now_state</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">Idle</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">Self</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">config</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">event_queue</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">now_state</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">start</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">event_queue</span><span class="tok-p">.</span><span class="tok-n">enqueue</span><span class="tok-p">(</span><span class="tok-n">Event</span>::<span class="tok-n">ManualStart</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">next_step</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-nb">Some</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">event_queue</span><span class="tok-p">.</span><span class="tok-n">dequeue</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">handle_event</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">fn</span> <span class="tok-nf">handle_event</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">event</span>: <span class="tok-nc">Event</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">State</span>::<span class="tok-n">Idle</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">event</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">Event</span>::<span class="tok-n">ManualStart</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">                    </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">Connect</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">                </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{}</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-p">},</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">(),</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cp">#[derive(Debug, PartialEq, Eq, Clone, Copy)]</span><span class="tok-w"></span>
<span class="tok-k">enum</span> <span class="tok-nc">State</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">Idle</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">Connect</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">OpenSent</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cp">#[derive(PartialEq, Eq, Clone, Copy)]</span><span class="tok-w"></span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">enum</span> <span class="tok-nc">Event</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">ManualStart</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">TcpCrAcked</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">TcpConnectionConfirmed</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cp">#[cfg(test)]</span><span class="tok-w"></span>
<span class="tok-k">mod</span> <span class="tok-nn">tests</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-k">super</span>::<span class="tok-o">*</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-cp">#[test]</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">fn</span> <span class="tok-nf">peer_can_transition_to_connect_start</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">config</span>: <span class="tok-nc">Config</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;64512 127.0.0.1 64513 127.0.0.2 active&quot;</span><span class="tok-p">.</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">bgp_peer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Peer</span>::<span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">config</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">bgp_peer</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">bgp_peer</span><span class="tok-p">.</span><span class="tok-n">next_step</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-fm">assert_eq!</span><span class="tok-p">(</span><span class="tok-n">bgp_peer</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">Connect</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/bgp/event_queue.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-k">crate</span>::<span class="tok-n">bgp</span>::<span class="tok-n">peer</span>::<span class="tok-n">Event</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">collections</span>::<span class="tok-n">VecDeque</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">EventQueue</span><span class="tok-p">(</span><span class="tok-n">VecDeque</span><span class="tok-o">&lt;</span><span class="tok-n">Event</span><span class="tok-o">&gt;</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">EventQueue</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">new</span><span class="tok-p">()</span><span class="tok-w"> </span>-&gt; <span class="tok-nc">Self</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">EventQueue</span><span class="tok-p">(</span><span class="tok-n">VecDeque</span>::<span class="tok-n">new</span><span class="tok-p">())</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">enqueue</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">event</span>: <span class="tok-nc">Event</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-mf">0.</span><span class="tok-n">push_front</span><span class="tok-p">(</span><span class="tok-n">event</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">fn</span> <span class="tok-nf">dequeue</span><span class="tok-p">(</span><span class="tok-o">&amp;</span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-bp">self</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Option</span><span class="tok-o">&lt;</span><span class="tok-n">Event</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-bp">self</span><span class="tok-p">.</span><span class="tok-mf">0.</span><span class="tok-n">pop_back</span><span class="tok-p">()</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/bgp/config.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><pre><span></span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-k">crate</span>::<span class="tok-n">bgp</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-p">{</span><span class="tok-n">net</span>::<span class="tok-n">Ipv4Addr</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-kt">str</span>::<span class="tok-n">FromStr</span><span class="tok-p">};</span><span class="tok-w"></span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">Config</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">local_as_number</span>: <span class="tok-nc">bgp</span>::<span class="tok-n">AutonomousSystemNumber</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">local_ip_address</span>: <span class="tok-nc">Ipv4Addr</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">remote_as_number</span>: <span class="tok-nc">bgp</span>::<span class="tok-n">AutonomousSystemNumber</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">remote_ip_address</span>: <span class="tok-nc">Ipv4Addr</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">mode</span>: <span class="tok-nc">Mode</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-k">enum</span> <span class="tok-nc">Mode</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">Passive</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-n">Active</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cp">#[derive(Debug)]</span><span class="tok-w"></span>
<span class="tok-k">struct</span> <span class="tok-nc">ModeParseError</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">FromStr</span><span class="tok-w"> </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">Mode</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">type</span> <span class="tok-nb">Err</span> <span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ModeParseError</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">fn</span> <span class="tok-nf">from_str</span><span class="tok-p">(</span><span class="tok-n">s</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-bp">Self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-bp">Self</span>::<span class="tok-nb">Err</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-k">match</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-s">&quot;active&quot;</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">Mode</span>::<span class="tok-n">Active</span><span class="tok-p">),</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-s">&quot;passive&quot;</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">Mode</span>::<span class="tok-n">Passive</span><span class="tok-p">),</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">_</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-nb">Err</span><span class="tok-p">(</span><span class="tok-n">ModeParseError</span><span class="tok-p">),</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>

<span class="tok-cp">#[derive(Debug)]</span><span class="tok-w"></span>
<span class="tok-k">pub</span><span class="tok-w"> </span><span class="tok-k">struct</span> <span class="tok-nc">ConfigParseError</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-k">impl</span><span class="tok-w"> </span><span class="tok-n">FromStr</span><span class="tok-w"> </span><span class="tok-k">for</span><span class="tok-w"> </span><span class="tok-n">Config</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">type</span> <span class="tok-nb">Err</span> <span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">ConfigParseError</span><span class="tok-p">;</span><span class="tok-w"></span>

<span class="tok-w">    </span><span class="tok-k">fn</span> <span class="tok-nf">from_str</span><span class="tok-p">(</span><span class="tok-n">s</span>: <span class="tok-kp">&amp;</span><span class="tok-kt">str</span><span class="tok-p">)</span><span class="tok-w"> </span>-&gt; <span class="tok-nb">Result</span><span class="tok-o">&lt;</span><span class="tok-bp">Self</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-bp">Self</span>::<span class="tok-nb">Err</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-c1">// 64512 127.0.0.1 64513 127.0.0.2 activeのようなテキストがパース対象</span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">c</span>: <span class="tok-nb">Vec</span><span class="tok-o">&lt;&amp;</span><span class="tok-kt">str</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">.</span><span class="tok-n">split</span><span class="tok-p">(</span><span class="tok-s">&quot; &quot;</span><span class="tok-p">).</span><span class="tok-n">collect</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">local_as_number</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">bgp</span>::<span class="tok-n">AutonomousSystemNumber</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;cannot parse local as number&quot;</span><span class="tok-p">));</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">local_ip_address</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">].</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;cannot parse local ip address&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">remote_as_number</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">bgp</span>::<span class="tok-n">AutonomousSystemNumber</span><span class="tok-p">(</span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">].</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;cannot parse local as number&quot;</span><span class="tok-p">));</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">remote_ip_address</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">3</span><span class="tok-p">].</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;cannot parse local ip address&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">mode</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">[</span><span class="tok-mi">4</span><span class="tok-p">].</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">expect</span><span class="tok-p">(</span><span class="tok-s">&quot;cannot parse mode&quot;</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">        </span><span class="tok-nb">Ok</span><span class="tok-p">(</span><span class="tok-n">Config</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">local_as_number</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">local_ip_address</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">remote_as_number</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">remote_ip_address</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">mode</span><span class="tok-p">,</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">})</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>それではテストを実行し、OKになることを確認しましょう。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">mrcsce@pop-os:~/programming/rustProjects/mrbgpdv2/mrbgpdv2first$ cargo test
   Compiling mrbgpdv2first v0.1.0 (/home/mrcsce/programming/rustProjects/mrbgpdv2/mrbgpdv2first)
    Finished test [unoptimized + debuginfo] target(s) in 0.48s
     Running unittests (target/debug/deps/mrbgpdv2first-773462fadd3e9533)

running 1 tests
test bgp::peer::tests::peer_can_transition_to_connect_start ... ok</pre>
</div>
</div>
<div class="paragraph">
<p>これでまた1つタスクが完了しました。</p>
</div>
<div class="ulist checklist">
<div class="title">タスクリスト</div>
<ul class="checklist">
<li>
<p>&#10003; プロジェクトを作成する</p>
</li>
<li>
<p>&#10003; Connect Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; ManualStart Eventを発生させる</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; OpenSent Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; TCPコネクションを作成する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; OpenConfirm Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Open Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Open Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Established Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Keepalive Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Keepalive Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; main関数を作成する</p>
</li>
<li>
<p>&#10063; テストする</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_connect_stateに遷移する_2">Connect Stateに遷移する</h4>
<div class="paragraph">
<p>次に下記に取り組みます。</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; OpenSent Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; TCPコネクションを作成する</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>まずはテストを書きます。
threadを使用して擬似的にリモート側のコンピュータを表しています。</p>
</div>
<div class="listingblock">
<div class="title">src/bgp/peer.rs</div>
<div class="content">
<pre class="pygments highlight nowrap"><code data-lang="rust"><table class="linenotable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><pre><span></span><span class="tok-cp">#[cfg(test)]</span><span class="tok-w"></span>
<span class="tok-k">mod</span> <span class="tok-nn">tests</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">thread</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">use</span><span class="tok-w"> </span><span class="tok-n">std</span>::<span class="tok-n">time</span><span class="tok-p">;</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-cp">#[test]</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-k">fn</span> <span class="tok-nf">peer_can_transition_to_open_sent_start</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">_remote_bgp</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">thread</span>::<span class="tok-n">spawn</span><span class="tok-p">(</span><span class="tok-o">||</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">remote_config</span>: <span class="tok-nc">Config</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;64513 127.0.0.2 64512 127.0.0.1 passive&quot;</span><span class="tok-p">.</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">remote_bgp_peer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Peer</span>::<span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">remote_config</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">remote_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">remote_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">next_step</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-n">remote_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">next_step</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">            </span><span class="tok-fm">assert_eq!</span><span class="tok-p">(</span><span class="tok-n">remote_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">OpenSent</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-p">});</span><span class="tok-w"></span>

<span class="tok-w">        </span><span class="tok-c1">// 先にPassiveモード側の処理が進むことを保証する。</span>
<span class="tok-w">        </span><span class="tok-n">thread</span>::<span class="tok-n">sleep</span><span class="tok-p">(</span><span class="tok-n">time</span>::<span class="tok-n">Duration</span>::<span class="tok-n">from_secs_f32</span><span class="tok-p">(</span><span class="tok-mf">0.5</span><span class="tok-p">));</span><span class="tok-w"></span>

<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-n">local_config</span>: <span class="tok-nc">Config</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;64512 127.0.0.1 64513 127.0.0.2 active&quot;</span><span class="tok-p">.</span><span class="tok-n">parse</span><span class="tok-p">().</span><span class="tok-n">unwrap</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-kd">let</span><span class="tok-w"> </span><span class="tok-k">mut</span><span class="tok-w"> </span><span class="tok-n">local_bgp_peer</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">Peer</span>::<span class="tok-n">new</span><span class="tok-p">(</span><span class="tok-n">local_config</span><span class="tok-p">);</span><span class="tok-w"></span>

<span class="tok-w">        </span><span class="tok-n">local_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">start</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">local_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">next_step</span><span class="tok-p">();</span><span class="tok-w"></span>
<span class="tok-w">        </span><span class="tok-n">local_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">next_step</span><span class="tok-p">();</span><span class="tok-w"></span>

<span class="tok-w">        </span><span class="tok-fm">assert_eq!</span><span class="tok-p">(</span><span class="tok-n">local_bgp_peer</span><span class="tok-p">.</span><span class="tok-n">now_state</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">State</span>::<span class="tok-n">OpenSent</span><span class="tok-p">);</span><span class="tok-w"></span>
<span class="tok-w">    </span><span class="tok-p">}</span><span class="tok-w"></span>
<span class="tok-p">}</span><span class="tok-w"></span>
</pre></td></tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>このテストが通れば、上記のタスクは完了したと言えます。
以下のようなコードでテストを通すことが可能です。</p>
</div>
<div class="paragraph">
<p><a href="#diff_of_before">[diff_of_before]</a>、
<a href="https://github.com/Miyoshi-Ryota/mrbgpdv2/tree/f133fc092a43103322ceadb4b40d9d9f28952548/mrbgpdv2first">テストが通る全体のコード</a></p>
</div>
 <script type="module" src="https://unpkg.com/x-frame-bypass"></script>
<iframe is="x-frame-bypass" src="https://github.com/Miyoshi-Ryota/mrbgpdv2/compare/4028dd5957849b2ed4b3d7432f56667125163f92...f133fc092a43103322ceadb4b40d9d9f28952548?diff=split" onload='javascript:(function(o){o.style.height=o.contentWindow.document.body.scrollHeight+"px";}(this));' style="height:200px;width:100%;border:none;overflow:hidden;" frameborder="0" title="GitHub"></iframe>
 <script type="module" src="https://unpkg.com/x-frame-bypass"></script>
<iframe is="x-frame-bypass" src="https://github.com/Miyoshi-Ryota/mrbgpdv2/compare/4028dd5957849b2ed4b3d7432f56667125163f92...f133fc092a43103322ceadb4b40d9d9f28952548" onload='javascript:(function(o){o.style.height=o.contentWindow.document.body.scrollHeight+"px";}(this));' style="height:200px;width:100%;border:none;overflow:hidden;" frameborder="0" title="GitHub"></iframe>
<div class="paragraph">
<p>本コードでは76行目〜77行目でバインドしています。
これはroot権限が必要な操作です。
root権限でテストを実行可能にする必要があります。
cargoのコンフィグファイルにrunner = 'sudo -E&#8217;と指定することで
root権限でテストを実行してくれます。</p>
</div>
<div class="listingblock">
<div class="title">~/.cargo/config</div>
<div class="content">
<pre class="pygments highlight nowrap"><code><span></span>mrcsce@pop-os:~/programming/rustProjects/mrbgpdv2/mrbgpdv2first$ cat ~/.cargo/config

# nightly-x86_64-unknown-linux-gnu
[target.x86_64-unknown-linux-gnu]
runner = &#39;sudo -E&#39;
mrcsce@pop-os:~/programming/rustProjects/mrbgpdv2/mrbgpdv2first$</code></pre>
</div>
</div>
<div class="paragraph">
<p>テストを走らせてみましょう。
下記が結果です。無事にテストが通っていることが確認できました。</p>
</div>
<div class="listingblock">
<div class="title">テスト結果</div>
<div class="content">
<pre class="pygments highlight nowrap"><code><span></span>mrcsce@pop-os:~/programming/rustProjects/mrbgpdv2/mrbgpdv2first$ cargo test
    Finished test [unoptimized + debuginfo] target(s) in 0.00s
     Running unittests (target/debug/deps/mrbgpdv2first-773462fadd3e9533)

running 2 tests
test bgp::peer::tests::peer_can_transition_to_connect_start ... ok
test bgp::peer::tests::peer_can_transition_to_open_sent_start ... ok

test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.50s

     Running unittests (target/debug/deps/mrbgpdv2first-eb97df666ba678c7)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

   Doc-tests mrbgpdv2first

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

mrcsce@pop-os:~/programming/rustProjects/mrbgpdv2/mrbgpdv2first$</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、またタスクが一つ完了しました。</p>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; プロジェクトを作成する</p>
</li>
<li>
<p>&#10003; Connect Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; ManualStart Eventを発生させる</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10003; OpenSent Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; TCPコネクションを作成する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; OpenConfirm Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Open Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Open Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Established Stateに遷移する</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; BGP Keepalive Messageを送信する</p>
</li>
<li>
<p>&#10063; BGP Keepalive Messageを受信する</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; main関数を作成する</p>
</li>
<li>
<p>&#10063; テストする</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1つのピアでupdate_messageの交換やupdate_messageの内容に従ってrouting_tableへの書き込みを可能にするところまでの実装">1つのピアでUpdate Messageの交換やUpdate Messageの内容に従ってRouting Tableへの書き込みを可能にするところまでの実装</h3>

</div>
<div class="sect2">
<h3 id="_main関数の実装">main関数の実装</h3>

</div>
<div class="sect2">
<h3 id="_本章で作るものの全体像">本章で作るものの全体像</h3>
<div class="imageblock">
<div class="content">
<img src="diag-ddf89ef96487aaa351ed4da907f88d67.png" alt="Diagram" width="93" height="189">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_複数ピアをハンドリング可能な実装">複数ピアをハンドリング可能な実装</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_本章で作るものの全体像_2">本章で作るものの全体像</h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="_他社実装との疎通確認">他社実装との疎通確認</h2>
<div class="sectionbody">

</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-05-09 23:36:26 UTC
</div>
</div>
</body>
</html>